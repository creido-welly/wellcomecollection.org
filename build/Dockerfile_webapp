FROM keymetrics/pm2-docker-alpine:8

ARG WEBAPP_NAME
ARG WEBAPP_PORT

# setup a user so as not to run as root
# see: https://github.com/nodejs/docker-node/blob/master/docs/BestPractices.md#non-root-user
RUN adduser -S wellcomecollection
ENV HOME=/home/wellcomecollection
USER wellcomecollection
WORKDIR $HOME/

COPY ./${WEBAPP_NAME}/app/.dist ./
COPY ./build/pm2_webapp.yml ./pm2.yml
RUN sed -i "s/WEBAPP_NAME/${WEBAPP_NAME}/g" ./pm2.yml

EXPOSE ${WEBAPP_PORT}
CMD ["pm2-docker", "--json", "pm2.yml"]
